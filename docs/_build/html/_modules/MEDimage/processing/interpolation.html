<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MEDimage.processing.interpolation &mdash; MEDimage  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> MEDimage
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">MEDimage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQs.html">FAQs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MEDimage</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>MEDimage.processing.interpolation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for MEDimage.processing.interpolation</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>


<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">MEDimage.MEDimage</span> <span class="kn">import</span> <span class="n">MEDimage</span>
<span class="kn">from</span> <span class="nn">MEDimage.processing.segmentation</span> <span class="kn">import</span> <span class="n">compute_box</span>
<span class="kn">from</span> <span class="nn">..utils.image_volume_obj</span> <span class="kn">import</span> <span class="n">image_volume_obj</span>
<span class="kn">from</span> <span class="nn">..utils.imref</span> <span class="kn">import</span> <span class="n">imref3d</span><span class="p">,</span> <span class="n">intrinsicToWorld</span><span class="p">,</span> <span class="n">worldToIntrinsic</span>
<span class="kn">from</span> <span class="nn">..utils.interp3</span> <span class="kn">import</span> <span class="n">interp3</span>


<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="interp_volume"><a class="viewcode-back" href="../../../MEDimage.processing.html#MEDimage.processing.interpolation.interp_volume">[docs]</a><span class="k">def</span> <span class="nf">interp_volume</span><span class="p">(</span><span class="n">MEDimage</span><span class="p">:</span> <span class="n">MEDimage</span><span class="p">,</span> 
                  <span class="n">vol_obj_s</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                  <span class="n">vox_dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">interp_met</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">round_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">image_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">roi_obj_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">box_string</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">image_volume_obj</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;3D voxel interpolation on the input volume.</span>

<span class="sd">    Args:</span>
<span class="sd">        MEDimage (object): The MEDimage class object.</span>
<span class="sd">        vol_obj_s (image_volume_obj): Imaging  that will be interpolated.</span>
<span class="sd">        vox_dim (array): Array of the voxel dimension. The following format is used</span>
<span class="sd">                         [Xin,Yin,Zslice], where Xin and Yin are the X (left to right) and</span>
<span class="sd">                         Y (bottom to top) IN-PLANE resolutions, and Zslice is the slice spacing,</span>
<span class="sd">                         no matter the orientation of the volume (i.e. axial , sagittal, coronal).</span>
<span class="sd">        interp_met (str): {nearest, linear, spline, cubic} optional, Interpolation method</span>
<span class="sd">        round_val (float): Rounding value. Must be between 0 and 1 for ROI interpolation</span>
<span class="sd">                           and to a power of 10 for Image interpolation.</span>
<span class="sd">        image_type (str): &#39;image&#39; for imaging data interpolation and &#39;roi&#39; for ROI mask data interpolation.</span>
<span class="sd">        roi_obj_s (image_volume_obj): Mask data, will be used to compute a new specific box</span>
<span class="sd">                                      and the new imref3d object for the imaging data.</span>
<span class="sd">        box_string (str): Specifies the size if the box containing the ROI</span>

<span class="sd">                          - &#39;full&#39;: full imaging data as output.</span>
<span class="sd">                          - &#39;box&#39;: computes the smallest bounding box.</span>
<span class="sd">                          - Ex: &#39;box10&#39;: 10 voxels in all three dimensions are added to \</span>
<span class="sd">                            the smallest bounding box. The number after &#39;box&#39; defines the \</span>
<span class="sd">                            number of voxels to add.</span>
<span class="sd">                          - Ex: &#39;2box&#39;: Computes the smallest box and outputs double its \</span>
<span class="sd">                            size. The number before &#39;box&#39; defines the multiplication in size.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: 3D array of 1&#39;s and 0&#39;s defining the ROI mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># PARSING ARGUMENTS</span>
        <span class="k">if</span> <span class="n">vox_dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">vol_obj_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vox_dim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">vol_obj_s</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vox_dim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">two_d</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">two_d</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">interp_met</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Interpolation method should be provided.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The type of input image should be specified as </span><span class="se">\&quot;</span><span class="s2">image</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">roi</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The type of input image should either be </span><span class="se">\&quot;</span><span class="s2">image</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">roi</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">image_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interp_met</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;cubic&quot;</span><span class="p">,</span> <span class="s2">&quot;spline&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Interpolation method for images should either be </span><span class="se">\&quot;</span><span class="s2">linear</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">cubic</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">spline</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">round_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">round_val</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">round_val</span><span class="se">\&quot;</span><span class="s2"> should be a power of 10.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interp_met</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;cubic&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Interpolation method for images should either be </span><span class="se">\&quot;</span><span class="s2">nearest</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">linear</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">cubic</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">round_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">round_val</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">round_val</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">round_val</span><span class="se">\&quot;</span><span class="s2"> must be between 0.0 and 1.0.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">round_val</span><span class="se">\&quot;</span><span class="s2"> must be provided for </span><span class="se">\&quot;</span><span class="s2">roi</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">roi_obj_s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">box_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_box</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_box</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># --&gt; QUERIED POINTS: NEW INTERPOLATED VOLUME: &quot;q&quot; or &quot;Q&quot;.</span>
        <span class="c1"># --&gt; SAMPLED POINTS: ORIGINAL VOLUME: &quot;s&quot; or &quot;S&quot;.</span>
        <span class="c1"># --&gt; Always using XYZ coordinates (unless specifically noted),</span>
        <span class="c1">#     not MATLAB IJK, so beware!</span>

        <span class="c1"># INITIALIZATION</span>
        <span class="n">res_q</span> <span class="o">=</span> <span class="n">vox_dim</span>
        <span class="k">if</span> <span class="n">two_d</span><span class="p">:</span>
            <span class="c1"># If 2D, the resolution of the slice dimension of he queried volume is</span>
            <span class="c1"># set to the same as the sampled volume.</span>
            <span class="n">res_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">res_q</span><span class="p">,</span> <span class="n">vol_obj_s</span><span class="o">.</span><span class="n">spatialRef</span><span class="o">.</span><span class="n">PixelExtentInWorldZ</span><span class="p">))</span>

        <span class="n">res_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vol_obj_s</span><span class="o">.</span><span class="n">spatialRef</span><span class="o">.</span><span class="n">PixelExtentInWorldX</span><span class="p">,</span>
                        <span class="n">vol_obj_s</span><span class="o">.</span><span class="n">spatialRef</span><span class="o">.</span><span class="n">PixelExtentInWorldY</span><span class="p">,</span>
                        <span class="n">vol_obj_s</span><span class="o">.</span><span class="n">spatialRef</span><span class="o">.</span><span class="n">PixelExtentInWorldZ</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">res_s</span><span class="p">,</span> <span class="n">res_q</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">vol_obj_s</span><span class="p">)</span>

        <span class="n">spatial_ref_s</span> <span class="o">=</span> <span class="n">vol_obj_s</span><span class="o">.</span><span class="n">spatialRef</span>
        <span class="n">extent_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spatial_ref_s</span><span class="o">.</span><span class="n">ImageExtentInWorldX</span><span class="p">,</span>
                            <span class="n">spatial_ref_s</span><span class="o">.</span><span class="n">ImageExtentInWorldY</span><span class="p">,</span>
                            <span class="n">spatial_ref_s</span><span class="o">.</span><span class="n">ImageExtentInWorldZ</span><span class="p">])</span>
        <span class="n">low_limits_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spatial_ref_s</span><span class="o">.</span><span class="n">XWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">spatial_ref_s</span><span class="o">.</span><span class="n">YWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">spatial_ref_s</span><span class="o">.</span><span class="n">ZWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="c1"># CREATING QUERIED &quot;imref3d&quot; OBJECT CENTERED ON SAMPLED VOLUME</span>

        <span class="c1"># Switching to IJK (matlab) reference frame for &quot;imref3d&quot; computation.</span>
        <span class="c1"># Putting a &quot;ceil&quot;, according to IBSI standards. This is safer than &quot;round&quot;.</span>
        <span class="n">size_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">extent_s</span><span class="p">,</span> <span class="n">res_q</span><span class="p">),</span>
                                <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">two_d</span><span class="p">:</span>
            <span class="c1"># If 2D, forcing the size of the queried volume in the slice dimension</span>
            <span class="c1"># to be the same as the sample volume.</span>
            <span class="n">size_q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_obj_s</span><span class="o">.</span><span class="n">spatialRef</span><span class="o">.</span><span class="n">ImageSize</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">spatial_ref_q</span> <span class="o">=</span> <span class="n">imref3d</span><span class="p">(</span><span class="n">imageSize</span><span class="o">=</span><span class="n">size_q</span><span class="p">,</span> 
                            <span class="n">pixelExtentInWorldX</span><span class="o">=</span><span class="n">res_q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">pixelExtentInWorldY</span><span class="o">=</span><span class="n">res_q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">pixelExtentInWorldZ</span><span class="o">=</span><span class="n">res_q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">extent_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">ImageExtentInWorldX</span><span class="p">,</span>
                            <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">ImageExtentInWorldY</span><span class="p">,</span>
                            <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">ImageExtentInWorldZ</span><span class="p">])</span>
        <span class="n">low_limits_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">XWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">YWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">ZWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">extent_q</span> <span class="o">-</span> <span class="n">extent_s</span>
        <span class="n">new_low_limits_q</span> <span class="o">=</span> <span class="n">low_limits_s</span> <span class="o">-</span> <span class="n">diff</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">XWorldLimits</span> <span class="o">=</span> <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">XWorldLimits</span> <span class="o">-</span> \
            <span class="p">(</span><span class="n">low_limits_q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">YWorldLimits</span> <span class="o">=</span> <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">YWorldLimits</span> <span class="o">-</span> \
            <span class="p">(</span><span class="n">low_limits_q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">ZWorldLimits</span> <span class="o">=</span> <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">ZWorldLimits</span> <span class="o">-</span> \
            <span class="p">(</span><span class="n">low_limits_q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># REDUCE THE SIZE OF THE VOLUME PRIOR TO INTERPOLATION</span>
        <span class="c1"># TODO check that compute_box vol and roi are intended to be the same!</span>
        <span class="k">if</span> <span class="n">use_box</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tempSpatialRef</span> <span class="o">=</span> <span class="n">compute_box</span><span class="p">(</span>
                <span class="n">vol</span><span class="o">=</span><span class="n">roi_obj_s</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">roi_obj_s</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">spatial_ref</span><span class="o">=</span><span class="n">vol_obj_s</span><span class="o">.</span><span class="n">spatialRef</span><span class="p">,</span>
                <span class="n">box_string</span><span class="o">=</span><span class="n">box_string</span><span class="p">)</span>

            <span class="n">size_temp</span> <span class="o">=</span> <span class="n">tempSpatialRef</span><span class="o">.</span><span class="n">ImageSize</span>

            <span class="c1"># Getting world boundaries (center of voxels) of the new box</span>
            <span class="n">x_bound</span><span class="p">,</span> <span class="n">y_bound</span><span class="p">,</span> <span class="n">z_bound</span> <span class="o">=</span> <span class="n">intrinsicToWorld</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="n">tempSpatialRef</span><span class="p">,</span>
                                                    <span class="n">xIntrinsic</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">size_temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]),</span>
                                                    <span class="n">yIntrinsic</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">size_temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]),</span>
                                                    <span class="n">zIntrinsic</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">size_temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]))</span>

            <span class="c1"># Getting the image positions of the boundaries of the new box, IN THE</span>
            <span class="c1"># FULL QUERIED FRAME OF REFERENCE (centered on the sampled frame of</span>
            <span class="c1"># reference).</span>
            <span class="n">x_bound</span><span class="p">,</span> <span class="n">y_bound</span><span class="p">,</span> <span class="n">z_bound</span> <span class="o">=</span> <span class="n">worldToIntrinsic</span><span class="p">(</span>
                <span class="n">R</span><span class="o">=</span><span class="n">spatial_ref_q</span><span class="p">,</span> <span class="n">xWorld</span><span class="o">=</span><span class="n">x_bound</span><span class="p">,</span> <span class="n">yWorld</span><span class="o">=</span><span class="n">y_bound</span><span class="p">,</span> <span class="n">zWorld</span><span class="o">=</span><span class="n">z_bound</span><span class="p">)</span>

            <span class="c1"># Rounding to the nearest image position integer</span>
            <span class="n">x_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x_bound</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">y_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y_bound</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">z_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">z_bound</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">size_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                            <span class="n">y_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Converting back to world positions ion order to correctly define</span>
            <span class="c1"># edges of the new box and thus center it onto the full queried</span>
            <span class="c1"># reference frame</span>
            <span class="n">x_bound</span><span class="p">,</span> <span class="n">y_bound</span><span class="p">,</span> <span class="n">z_bound</span> <span class="o">=</span> <span class="n">intrinsicToWorld</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="n">spatial_ref_q</span><span class="p">,</span>
                                                    <span class="n">xIntrinsic</span><span class="o">=</span><span class="n">x_bound</span><span class="p">,</span>
                                                    <span class="n">yIntrinsic</span><span class="o">=</span><span class="n">y_bound</span><span class="p">,</span>
                                                    <span class="n">zIntrinsic</span><span class="o">=</span><span class="n">z_bound</span><span class="p">)</span>

            <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>

            <span class="n">spatial_ref_q</span> <span class="o">=</span> <span class="n">imref3d</span><span class="p">(</span><span class="n">imageSize</span><span class="o">=</span><span class="n">size_q</span><span class="p">,</span> 
                                <span class="n">pixelExtentInWorldX</span><span class="o">=</span><span class="n">res_q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">pixelExtentInWorldY</span><span class="o">=</span><span class="n">res_q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">pixelExtentInWorldZ</span><span class="o">=</span><span class="n">res_q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">XWorldLimits</span> <span class="o">-=</span> <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">XWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> \
                <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">YWorldLimits</span> <span class="o">-=</span> <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">YWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> \
                <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">ZWorldLimits</span> <span class="o">-=</span> <span class="n">spatial_ref_q</span><span class="o">.</span><span class="n">ZWorldLimits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> \
                <span class="n">new_low_limits_q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># CREATING QUERIED XYZ POINTS</span>
        <span class="n">x_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size_q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size_q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">z_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size_q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">x_q</span><span class="p">,</span> <span class="n">y_q</span><span class="p">,</span> <span class="n">z_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_q</span><span class="p">,</span> <span class="n">y_q</span><span class="p">,</span> <span class="n">z_q</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">x_q</span><span class="p">,</span> <span class="n">y_q</span><span class="p">,</span> <span class="n">z_q</span> <span class="o">=</span> <span class="n">intrinsicToWorld</span><span class="p">(</span>
            <span class="n">R</span><span class="o">=</span><span class="n">spatial_ref_q</span><span class="p">,</span> <span class="n">xIntrinsic</span><span class="o">=</span><span class="n">x_q</span><span class="p">,</span> <span class="n">yIntrinsic</span><span class="o">=</span><span class="n">y_q</span><span class="p">,</span> <span class="n">zIntrinsic</span><span class="o">=</span><span class="n">z_q</span><span class="p">)</span>

        <span class="c1"># CONVERTING QUERIED XZY POINTS TO INTRINSIC COORDINATES IN THE SAMPLED</span>
        <span class="c1"># REFERENCE FRAME</span>
        <span class="n">x_q</span><span class="p">,</span> <span class="n">y_q</span><span class="p">,</span> <span class="n">z_q</span> <span class="o">=</span> <span class="n">worldToIntrinsic</span><span class="p">(</span>
            <span class="n">R</span><span class="o">=</span><span class="n">spatial_ref_s</span><span class="p">,</span> <span class="n">xWorld</span><span class="o">=</span><span class="n">x_q</span><span class="p">,</span> <span class="n">yWorld</span><span class="o">=</span><span class="n">y_q</span><span class="p">,</span> <span class="n">zWorld</span><span class="o">=</span><span class="n">z_q</span><span class="p">)</span>

        <span class="c1"># INTERPOLATING VOLUME</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">interp3</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">vol_obj_s</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">x_q</span><span class="o">=</span><span class="n">x_q</span><span class="p">,</span> <span class="n">y_q</span><span class="o">=</span><span class="n">y_q</span><span class="p">,</span> <span class="n">z_q</span><span class="o">=</span><span class="n">z_q</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">interp_met</span><span class="p">)</span>
        <span class="n">vol_obj_q</span> <span class="o">=</span> <span class="n">image_volume_obj</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">spatial_ref</span><span class="o">=</span><span class="n">spatial_ref_q</span><span class="p">)</span>

        <span class="c1"># ROUNDING</span>
        <span class="k">if</span> <span class="n">image_type</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="c1"># Grey level rounding for &quot;image&quot; type</span>
            <span class="k">if</span> <span class="n">round_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">round_val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">round_val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">):</span>
                <span class="c1"># DELETE NEXT LINE WHEN THE RADIOMICS PARAMETER OPTIONS OF</span>
                <span class="c1"># interp.glRound ARE FIXED</span>
                <span class="n">round_val</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">round_val</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">vol_obj_q</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">vol_obj_q</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">round_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vol_obj_q</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vol_obj_q</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">round_val</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">vol_obj_q</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">vol_obj_q</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">round_val</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">MEDimage</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;scaleName&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> PROBLEM WITH PRE-PROCESSING OF TEXTURE FEATURES:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="n">MEDimage</span><span class="o">.</span><span class="n">Params</span><span class="p">[</span><span class="s1">&#39;radiomics&#39;</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{(</span> <span class="n">MEDimage</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">&#39;scaleName&#39;</span><span class="p">]</span> <span class="p">):</span> <span class="s1">&#39;ERROR_PROCESSING&#39;</span><span class="p">})</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> PROBLEM WITH PRE-PROCESSING OF TEXTURE FEATURES:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="n">MEDimage</span><span class="o">.</span><span class="n">Params</span><span class="p">[</span><span class="s1">&#39;radiomics&#39;</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{(</span><span class="s1">&#39;scale&#39;</span><span class="o">+</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">MEDimage</span><span class="o">.</span><span class="n">Params</span><span class="p">[</span><span class="s1">&#39;scaleNonText&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;dot&#39;</span><span class="p">)):</span> <span class="s1">&#39;ERROR_PROCESSING&#39;</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">vol_obj_q</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, MEDimage.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>